<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Comparing samplers | Liesel Tutorials</title>
  <meta name="description" content="Tutorial book for the Liesel probabilistic programming framework" />
  <meta name="generator" content="bookdown 0.26 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Comparing samplers | Liesel Tutorials" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/53620082" />
  <meta property="og:description" content="Tutorial book for the Liesel probabilistic programming framework" />
  <meta name="github-repo" content="liesel-devs/liesel-tutorials" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Comparing samplers | Liesel Tutorials" />
  
  <meta name="twitter:description" content="Tutorial book for the Liesel probabilistic programming framework" />
  <meta name="twitter:image" content="https://avatars.githubusercontent.com/u/53620082" />

<meta name="author" content="Hannes Riebl, Paul Wiemann" />


<meta name="date" content="2022-06-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="gev-responses.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Liesel Tutorials</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.1</b> Installation</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#further-reading"><i class="fa fa-check"></i><b>1.2</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="linear-regression.html"><a href="linear-regression.html"><i class="fa fa-check"></i><b>2</b> Linear regression</a>
<ul>
<li class="chapter" data-level="2.1" data-path="linear-regression.html"><a href="linear-regression.html#model-building-with-liesel"><i class="fa fa-check"></i><b>2.1</b> Model building with Liesel</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="linear-regression.html"><a href="linear-regression.html#probabilistic-graphical-models"><i class="fa fa-check"></i><b>2.1.1</b> Probabilistic graphical models</a></li>
<li class="chapter" data-level="2.1.2" data-path="linear-regression.html"><a href="linear-regression.html#generating-the-data"><i class="fa fa-check"></i><b>2.1.2</b> Generating the data</a></li>
<li class="chapter" data-level="2.1.3" data-path="linear-regression.html"><a href="linear-regression.html#building-the-model-graph"><i class="fa fa-check"></i><b>2.1.3</b> Building the model graph</a></li>
<li class="chapter" data-level="2.1.4" data-path="linear-regression.html"><a href="linear-regression.html#node-and-model-log-probabilities"><i class="fa fa-check"></i><b>2.1.4</b> Node and model log-probabilities</a></li>
<li class="chapter" data-level="2.1.5" data-path="linear-regression.html"><a href="linear-regression.html#pure-stateless-jax-functions"><i class="fa fa-check"></i><b>2.1.5</b> Pure, stateless JAX functions</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="linear-regression.html"><a href="linear-regression.html#mcmc-inference-with-goose"><i class="fa fa-check"></i><b>2.2</b> MCMC inference with Goose</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="linear-regression.html"><a href="linear-regression.html#using-a-gibbs-kernel"><i class="fa fa-check"></i><b>2.2.1</b> Using a Gibbs kernel</a></li>
<li class="chapter" data-level="2.2.2" data-path="linear-regression.html"><a href="linear-regression.html#parameter-transformations"><i class="fa fa-check"></i><b>2.2.2</b> Parameter transformations</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="location-scale-regression.html"><a href="location-scale-regression.html"><i class="fa fa-check"></i><b>3</b> Location-scale regression</a></li>
<li class="chapter" data-level="4" data-path="gev-responses.html"><a href="gev-responses.html"><i class="fa fa-check"></i><b>4</b> GEV responses</a></li>
<li class="chapter" data-level="5" data-path="comparing-samplers.html"><a href="comparing-samplers.html"><i class="fa fa-check"></i><b>5</b> Comparing samplers</a>
<ul>
<li class="chapter" data-level="5.1" data-path="comparing-samplers.html"><a href="comparing-samplers.html#metropolis-in-gibbs"><i class="fa fa-check"></i><b>5.1</b> Metropolis-in-Gibbs</a></li>
<li class="chapter" data-level="5.2" data-path="comparing-samplers.html"><a href="comparing-samplers.html#nuts-sampler"><i class="fa fa-check"></i><b>5.2</b> NUTS sampler</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Liesel Tutorials</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="comparing-samplers" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Comparing samplers<a href="comparing-samplers.html#comparing-samplers" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this tutorial, we are comparing two different sampling schemes on the <code>mcycle</code> dataset with a Gaussian location-scale regression model and two splines for the mean and the standard deviation. The <code>mcycle</code> dataset is a “data frame giving a series of measurements of head acceleration in a simulated motorcycle accident, used to test crash helmets” (from the help page). It contains the following two variables:</p>
<ul>
<li><code>times</code>: in milliseconds after impact</li>
<li><code>accel</code>: in g</li>
</ul>
<p>We start off in R by loading the dataset and setting up the model with the <code>rliesel::liesel()</code> function.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="comparing-samplers.html#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;MASS&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     select</code></pre>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="comparing-samplers.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rliesel)</span>
<span id="cb120-2"><a href="comparing-samplers.html#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="comparing-samplers.html#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="fu">use_liesel_venv</span>()</span></code></pre></div>
<pre><code>## [1] &quot;/home/hannes/.local/share/virtualenvs/liesel-tutorials-1k9wp3mI&quot;</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="comparing-samplers.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mcycle)</span>
<span id="cb122-2"><a href="comparing-samplers.html#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(mcycle, <span class="fu">plot</span>(times, accel))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-54-1.png" width="672" /></p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="comparing-samplers.html#cb123-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">liesel</span>(</span>
<span id="cb123-2"><a href="comparing-samplers.html#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">response =</span> mcycle<span class="sc">$</span>accel,</span>
<span id="cb123-3"><a href="comparing-samplers.html#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">distribution =</span> <span class="st">&quot;Normal&quot;</span>,</span>
<span id="cb123-4"><a href="comparing-samplers.html#cb123-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">predictors =</span> <span class="fu">list</span>(</span>
<span id="cb123-5"><a href="comparing-samplers.html#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">loc =</span> <span class="fu">predictor</span>(<span class="sc">~</span> <span class="fu">s</span>(times)),</span>
<span id="cb123-6"><a href="comparing-samplers.html#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="fu">predictor</span>(<span class="sc">~</span> <span class="fu">s</span>(times), <span class="at">inverse_link =</span> <span class="st">&quot;Exp&quot;</span>)</span>
<span id="cb123-7"><a href="comparing-samplers.html#cb123-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb123-8"><a href="comparing-samplers.html#cb123-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mcycle</span>
<span id="cb123-9"><a href="comparing-samplers.html#cb123-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div id="metropolis-in-gibbs" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Metropolis-in-Gibbs<a href="comparing-samplers.html#metropolis-in-gibbs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>First, we try a Metropolis-in-Gibbs sampling scheme with IWLS kernels for the regression coefficients (<span class="math inline">\(\boldsymbol{\beta}\)</span>) and Gibbs kernels for the smoothing parameters (<span class="math inline">\(\tau^2\)</span>) of the splines.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb124-1"><a href="comparing-samplers.html#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> liesel.liesel <span class="im">as</span> lsl</span>
<span id="cb124-2"><a href="comparing-samplers.html#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="comparing-samplers.html#cb124-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> r.model</span>
<span id="cb124-4"><a href="comparing-samplers.html#cb124-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-5"><a href="comparing-samplers.html#cb124-5" aria-hidden="true" tabindex="-1"></a>builder <span class="op">=</span> lsl.dist_reg_mcmc(model, seed<span class="op">=</span><span class="dv">42</span>, num_chains<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb124-6"><a href="comparing-samplers.html#cb124-6" aria-hidden="true" tabindex="-1"></a>builder.set_duration(warmup_duration<span class="op">=</span><span class="dv">5000</span>, posterior_duration<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb124-7"><a href="comparing-samplers.html#cb124-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-8"><a href="comparing-samplers.html#cb124-8" aria-hidden="true" tabindex="-1"></a>engine <span class="op">=</span> builder.build()</span>
<span id="cb124-9"><a href="comparing-samplers.html#cb124-9" aria-hidden="true" tabindex="-1"></a>engine.sample_all_epochs()</span></code></pre></div>
<pre><code>## INFO - Starting epoch: FAST_ADAPTATION, 75 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_03: 1, 1, 1, 1 / 75 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 25 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_05: 1, 0, 0, 0 / 25 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 50 transitions, 25 jitted together
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 100 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_05: 0, 1, 0, 0 / 100 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 200 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_05: 1, 0, 1, 0 / 200 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 400 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_05: 1, 1, 1, 1 / 400 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 800 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_05: 1, 1, 1, 0 / 800 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 3300 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_02: 0, 0, 1, 0 / 3300 transitions
## WARNING - Errors per chain for kernel_05: 1, 0, 1, 1 / 3300 transitions
## INFO - Finished epoch
## INFO - Starting epoch: FAST_ADAPTATION, 50 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_05: 1, 0, 1, 1 / 50 transitions
## INFO - Finished epoch
## INFO - Finished warmup
## INFO - Starting epoch: POSTERIOR, 1000 transitions, 25 jitted together
## INFO - Finished epoch</code></pre>
<p>Clearly, the performance of the sampler could be better, especially for the intercept of the mean. The corresponding chain exhibits a very strong autocorrelation.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb126-1"><a href="comparing-samplers.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> liesel.goose <span class="im">as</span> gs</span>
<span id="cb126-2"><a href="comparing-samplers.html#cb126-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-3"><a href="comparing-samplers.html#cb126-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> engine.get_results()</span>
<span id="cb126-4"><a href="comparing-samplers.html#cb126-4" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> gs.summary(results)</span>
<span id="cb126-5"><a href="comparing-samplers.html#cb126-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-6"><a href="comparing-samplers.html#cb126-6" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;loc_p0_beta&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-56-1.png" width="385" /></p>
<div class="sourceCode" id="cb127"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb127-1"><a href="comparing-samplers.html#cb127-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;loc_np0_tau2&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-56-2.png" width="385" /></p>
<div class="sourceCode" id="cb128"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb128-1"><a href="comparing-samplers.html#cb128-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;loc_np0_beta&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-56-3.png" width="961" /></p>
<div class="sourceCode" id="cb129"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb129-1"><a href="comparing-samplers.html#cb129-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;scale_p0_beta&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-56-4.png" width="385" /></p>
<div class="sourceCode" id="cb130"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb130-1"><a href="comparing-samplers.html#cb130-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;scale_np0_tau2&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-56-5.png" width="385" /></p>
<div class="sourceCode" id="cb131"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb131-1"><a href="comparing-samplers.html#cb131-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;scale_np0_beta&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-56-6.png" width="961" /></p>
<p>To confirm that the chains have converged to reasonable values, here is a plot of the estimated mean function:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="comparing-samplers.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb132-2"><a href="comparing-samplers.html#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb132-3"><a href="comparing-samplers.html#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb132-4"><a href="comparing-samplers.html#cb132-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-5"><a href="comparing-samplers.html#cb132-5" aria-hidden="true" tabindex="-1"></a>summary <span class="ot">&lt;-</span> py<span class="sc">$</span>summary</span>
<span id="cb132-6"><a href="comparing-samplers.html#cb132-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-7"><a href="comparing-samplers.html#cb132-7" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> summary <span class="sc">%&gt;%</span></span>
<span id="cb132-8"><a href="comparing-samplers.html#cb132-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(index <span class="sc">==</span> <span class="st">&quot;loc_np0_beta&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb132-9"><a href="comparing-samplers.html#cb132-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(param_index) <span class="sc">%&gt;%</span></span>
<span id="cb132-10"><a href="comparing-samplers.html#cb132-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(mean)) <span class="sc">%&gt;%</span></span>
<span id="cb132-11"><a href="comparing-samplers.html#cb132-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb132-12"><a href="comparing-samplers.html#cb132-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-13"><a href="comparing-samplers.html#cb132-13" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> beta<span class="sc">$</span>mean</span>
<span id="cb132-14"><a href="comparing-samplers.html#cb132-14" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">py_to_r</span>(model<span class="sc">$</span>nodes<span class="sc">$</span>loc_np0_X<span class="sc">$</span>value)</span>
<span id="cb132-15"><a href="comparing-samplers.html#cb132-15" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> X <span class="sc">%*%</span> beta</span>
<span id="cb132-16"><a href="comparing-samplers.html#cb132-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-17"><a href="comparing-samplers.html#cb132-17" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> summary <span class="sc">%&gt;%</span></span>
<span id="cb132-18"><a href="comparing-samplers.html#cb132-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(index <span class="sc">==</span> <span class="st">&quot;loc_p0_beta&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb132-19"><a href="comparing-samplers.html#cb132-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(param_index) <span class="sc">%&gt;%</span></span>
<span id="cb132-20"><a href="comparing-samplers.html#cb132-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(mean)) <span class="sc">%&gt;%</span></span>
<span id="cb132-21"><a href="comparing-samplers.html#cb132-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb132-22"><a href="comparing-samplers.html#cb132-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-23"><a href="comparing-samplers.html#cb132-23" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> beta0<span class="sc">$</span>mean</span>
<span id="cb132-24"><a href="comparing-samplers.html#cb132-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-25"><a href="comparing-samplers.html#cb132-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">times =</span> mcycle<span class="sc">$</span>times, <span class="at">mean =</span> beta0 <span class="sc">+</span> f)) <span class="sc">+</span></span>
<span id="cb132-26"><a href="comparing-samplers.html#cb132-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(times, mean), <span class="at">color =</span> <span class="fu">palette</span>()[<span class="dv">2</span>], <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb132-27"><a href="comparing-samplers.html#cb132-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(times, accel), <span class="at">data =</span> mcycle) <span class="sc">+</span></span>
<span id="cb132-28"><a href="comparing-samplers.html#cb132-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Estimated mean function&quot;</span>) <span class="sc">+</span></span>
<span id="cb132-29"><a href="comparing-samplers.html#cb132-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-58-13.png" width="672" /></p>
</div>
<div id="nuts-sampler" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> NUTS sampler<a href="comparing-samplers.html#nuts-sampler" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As an alternative, we try a NUTS kernel which samples all model parameters (regression coefficients and smoothing parameters) in one block. To do so, we first need to log-transform the smoothing parameters. This is the model graph before the transformation:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb133-1"><a href="comparing-samplers.html#cb133-1" aria-hidden="true" tabindex="-1"></a>lsl.plot_model(model)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-59-1.png" width="1920" /></p>
<p>Before transforming the smoothing parameters with the <code>lsl.transform_parameter()</code> function, we first need to copy all model nodes. Once this is done, we need to update the output nodes of the smoothing parameters and rebuild the model. There are two additional nodes in the new model graph.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb134-1"><a href="comparing-samplers.html#cb134-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.transform_parameter(<span class="st">&quot;loc_np0_tau2&quot;</span>, <span class="st">&quot;Log&quot;</span>)</span>
<span id="cb134-2"><a href="comparing-samplers.html#cb134-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model.transform_parameter(<span class="st">&quot;scale_np0_tau2&quot;</span>, <span class="st">&quot;Log&quot;</span>)</span>
<span id="cb134-3"><a href="comparing-samplers.html#cb134-3" aria-hidden="true" tabindex="-1"></a>lsl.plot_model(model)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-60-3.png" width="1920" /></p>
<p>Now we can set up the NUTS sampler, which is straightforward because we are using only one kernel.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb135-1"><a href="comparing-samplers.html#cb135-1" aria-hidden="true" tabindex="-1"></a>parameters <span class="op">=</span> model.get_nodes_by_class(lsl.Parameter)</span>
<span id="cb135-2"><a href="comparing-samplers.html#cb135-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-3"><a href="comparing-samplers.html#cb135-3" aria-hidden="true" tabindex="-1"></a>builder <span class="op">=</span> gs.EngineBuilder(seed<span class="op">=</span><span class="dv">42</span>, num_chains<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb135-4"><a href="comparing-samplers.html#cb135-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-5"><a href="comparing-samplers.html#cb135-5" aria-hidden="true" tabindex="-1"></a>builder.set_model(lsl.GooseModel(model))</span>
<span id="cb135-6"><a href="comparing-samplers.html#cb135-6" aria-hidden="true" tabindex="-1"></a>builder.add_kernel(gs.NUTSKernel(parameters.keys()))</span>
<span id="cb135-7"><a href="comparing-samplers.html#cb135-7" aria-hidden="true" tabindex="-1"></a>builder.set_initial_values(model.state)</span>
<span id="cb135-8"><a href="comparing-samplers.html#cb135-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-9"><a href="comparing-samplers.html#cb135-9" aria-hidden="true" tabindex="-1"></a>builder.set_duration(warmup_duration<span class="op">=</span><span class="dv">5000</span>, posterior_duration<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb135-10"><a href="comparing-samplers.html#cb135-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-11"><a href="comparing-samplers.html#cb135-11" aria-hidden="true" tabindex="-1"></a>engine <span class="op">=</span> builder.build()</span>
<span id="cb135-12"><a href="comparing-samplers.html#cb135-12" aria-hidden="true" tabindex="-1"></a>engine.sample_all_epochs()</span></code></pre></div>
<pre><code>## INFO - Starting epoch: FAST_ADAPTATION, 75 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_00: 35, 24, 30, 37 / 75 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 25 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_00: 5, 2, 4, 4 / 25 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 50 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_00: 2, 1, 3, 2 / 50 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 100 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_00: 12, 4, 6, 10 / 100 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 200 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_00: 14, 11, 10, 20 / 200 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 400 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_00: 9, 22, 19, 12 / 400 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 800 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_00: 38, 53, 36, 31 / 800 transitions
## INFO - Finished epoch
## INFO - Starting epoch: SLOW_ADAPTATION, 3300 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_00: 159, 96, 123, 121 / 3300 transitions
## INFO - Finished epoch
## INFO - Starting epoch: FAST_ADAPTATION, 50 transitions, 25 jitted together
## WARNING - Errors per chain for kernel_00: 3, 6, 5, 5 / 50 transitions
## INFO - Finished epoch
## INFO - Finished warmup
## INFO - Starting epoch: POSTERIOR, 1000 transitions, 25 jitted together
## INFO - Finished epoch</code></pre>
<p>The results are mixed. On the one hand, the NUTS sampler performs much better on the intercepts (for both the mean and the standard deviation), but on the other hand, the Metropolis-in-Gibbs sampler with the IWLS kernels seems to work better for the spline coefficients.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb137-1"><a href="comparing-samplers.html#cb137-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> engine.get_results()</span>
<span id="cb137-2"><a href="comparing-samplers.html#cb137-2" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> gs.summary(results)</span>
<span id="cb137-3"><a href="comparing-samplers.html#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="comparing-samplers.html#cb137-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;loc_p0_beta&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-62-5.png" width="385" /></p>
<div class="sourceCode" id="cb138"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb138-1"><a href="comparing-samplers.html#cb138-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;loc_np0_tau2_transformed&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-62-6.png" width="385" /></p>
<div class="sourceCode" id="cb139"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb139-1"><a href="comparing-samplers.html#cb139-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;loc_np0_beta&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-62-7.png" width="961" /></p>
<div class="sourceCode" id="cb140"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb140-1"><a href="comparing-samplers.html#cb140-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;scale_p0_beta&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-62-8.png" width="385" /></p>
<div class="sourceCode" id="cb141"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb141-1"><a href="comparing-samplers.html#cb141-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;scale_np0_tau2_transformed&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-62-9.png" width="385" /></p>
<div class="sourceCode" id="cb142"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb142-1"><a href="comparing-samplers.html#cb142-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> gs.plot_trace(results, <span class="st">&quot;scale_np0_beta&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-62-10.png" width="961" /></p>
<p>Again, here is a plot of the estimated mean function:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="comparing-samplers.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb143-2"><a href="comparing-samplers.html#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb143-3"><a href="comparing-samplers.html#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb143-4"><a href="comparing-samplers.html#cb143-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-5"><a href="comparing-samplers.html#cb143-5" aria-hidden="true" tabindex="-1"></a>summary <span class="ot">&lt;-</span> py<span class="sc">$</span>summary</span>
<span id="cb143-6"><a href="comparing-samplers.html#cb143-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-7"><a href="comparing-samplers.html#cb143-7" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> summary <span class="sc">%&gt;%</span></span>
<span id="cb143-8"><a href="comparing-samplers.html#cb143-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(index <span class="sc">==</span> <span class="st">&quot;loc_np0_beta&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb143-9"><a href="comparing-samplers.html#cb143-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(param_index) <span class="sc">%&gt;%</span></span>
<span id="cb143-10"><a href="comparing-samplers.html#cb143-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(mean)) <span class="sc">%&gt;%</span></span>
<span id="cb143-11"><a href="comparing-samplers.html#cb143-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb143-12"><a href="comparing-samplers.html#cb143-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-13"><a href="comparing-samplers.html#cb143-13" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> beta<span class="sc">$</span>mean</span>
<span id="cb143-14"><a href="comparing-samplers.html#cb143-14" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">py_to_r</span>(model<span class="sc">$</span>nodes<span class="sc">$</span>loc_np0_X<span class="sc">$</span>value)</span>
<span id="cb143-15"><a href="comparing-samplers.html#cb143-15" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> X <span class="sc">%*%</span> beta</span>
<span id="cb143-16"><a href="comparing-samplers.html#cb143-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-17"><a href="comparing-samplers.html#cb143-17" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> summary <span class="sc">%&gt;%</span></span>
<span id="cb143-18"><a href="comparing-samplers.html#cb143-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(index <span class="sc">==</span> <span class="st">&quot;loc_p0_beta&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb143-19"><a href="comparing-samplers.html#cb143-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(param_index) <span class="sc">%&gt;%</span></span>
<span id="cb143-20"><a href="comparing-samplers.html#cb143-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(mean)) <span class="sc">%&gt;%</span></span>
<span id="cb143-21"><a href="comparing-samplers.html#cb143-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb143-22"><a href="comparing-samplers.html#cb143-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-23"><a href="comparing-samplers.html#cb143-23" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> beta0<span class="sc">$</span>mean</span>
<span id="cb143-24"><a href="comparing-samplers.html#cb143-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-25"><a href="comparing-samplers.html#cb143-25" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">times =</span> mcycle<span class="sc">$</span>times, <span class="at">mean =</span> beta0 <span class="sc">+</span> f)) <span class="sc">+</span></span>
<span id="cb143-26"><a href="comparing-samplers.html#cb143-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(times, mean), <span class="at">color =</span> <span class="fu">palette</span>()[<span class="dv">2</span>], <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb143-27"><a href="comparing-samplers.html#cb143-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(times, accel), <span class="at">data =</span> mcycle) <span class="sc">+</span></span>
<span id="cb143-28"><a href="comparing-samplers.html#cb143-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Estimated mean function&quot;</span>) <span class="sc">+</span></span>
<span id="cb143-29"><a href="comparing-samplers.html#cb143-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-64-17.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="gev-responses.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/liesel-devs/liesel-tutorials/edit/main/rmarkdown/05-mcycle.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
